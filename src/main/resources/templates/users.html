<!doctype html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f8f9fa; }
        .sidebar { min-height: calc(100vh - 56px); }
        .nav-link.active { background:#0d6efd; color:#fff !important; }
        .table thead th { background:#f1f3f5; }
    </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">Admin panel</a>
        <div class="d-flex align-items-center gap-3 text-white-50">
            <span th:text="${user.email}">email</span> with roles:
            <span th:each="r : ${user.roles}" class="badge text-bg-secondary me-1"
                  th:text="${#strings.replace(r.name,'ROLE_','')}">ADMIN</span>
            <form th:action="@{/logout}" method="post" class="m-0">
                <button class="btn btn-outline-light btn-sm" type="submit">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <aside class="col-12 col-md-2 bg-white border-end sidebar p-0">
            <ul class="nav flex-column nav-pills p-3 gap-2">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/admin}">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/user}">User</a>
                </li>
            </ul>
        </aside>

        <!-- Content -->
        <main class="col-12 col-md-10 p-4">
            <h2 class="mb-3">Admin panel</h2>

            <!-- Tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="users-tab" data-bs-toggle="tab"
                       href="#users-pane" role="tab" aria-controls="users-pane" aria-selected="true">Users table</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="newuser-tab" data-bs-toggle="tab"
                       href="#newuser-pane" role="tab" aria-controls="newuser-pane" aria-selected="false">New User</a>
                </li>
            </ul>

            <div class="tab-content border border-top-0 bg-white p-3 rounded-bottom">
                <!-- Users table -->
                <div class="tab-pane fade show active" id="users-pane" role="tabpanel" aria-labelledby="users-tab">
                    <h5 class="mb-3">All users</h5>
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead>
                            <tr>
                                <th style="width:70px;">ID</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th style="width:90px;">Age</th>
                                <th>Email</th>
                                <th style="width:160px;">Role</th>
                                <th style="width:90px;">Edit</th>
                                <th style="width:100px;">Delete</th>
                            </tr>
                            </thead>
                            <tbody id="users-tbody"><!-- JS fills here --></tbody>
                        </table>
                    </div>
                </div>

                <!-- New User -->
                <div class="tab-pane fade" id="newuser-pane" role="tabpanel" aria-labelledby="newuser-tab">
                    <h5 class="mb-3">Add new user</h5>
                    <div class="row">
                        <div class="col-lg-6">
                            <form id="create-form" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label class="form-label">Login</label>
                                    <input class="form-control" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input class="form-control" type="password" name="password" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name</label>
                                        <input class="form-control" name="name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name</label>
                                        <input class="form-control" name="lastName" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Age</label>
                                        <input class="form-control" type="number" min="0" name="age" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email</label>
                                        <input class="form-control" type="email" name="email" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" id="create-roles" multiple size="2"></select>
                                </div>
                                <button class="btn btn-success" type="submit">Add new user</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const api = {
        users: '/api/users',
        roles: '/api/roles'
    };

    let ROLES = [];

    const $tbody = document.getElementById('users-tbody');
    const $createForm = document.getElementById('create-form');
    const $createRoles = document.getElementById('create-roles');

    async function getJSON(url) {
        const res = await fetch(url, {credentials: 'same-origin'});
        if (!res.ok) throw new Error(await res.text());
        return res.json();
    }
    async function sendJSON(url, method, data) {
        const res = await fetch(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        if (!res.ok) throw new Error(await res.text());
        return res.status === 204 ? null : res.json();
    }
    function roleBadge(name) {
        return `<span class="badge text-bg-secondary me-1">${name.replace('ROLE_','')}</span>`;
    }

    function renderRolesSelect($select, selectedIds = []) {
        $select.innerHTML = ROLES.map(r => {
            const sel = selectedIds.includes(r.id) ? 'selected' : '';
            return `<option value="${r.id}" ${sel}>${r.name}</option>`;
        }).join('');
    }

    function renderUsersTable(users) {
        $tbody.innerHTML = users.map(u => {
            const rolesBadges = u.roles.map(r => roleBadge(r.name)).join('');
            return `
        <tr data-id="${u.id}">
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.lastName}</td>
          <td>${u.age}</td>
          <td>${u.email}</td>
          <td>${rolesBadges}</td>
          <td><button class="btn btn-sm btn-info text-white" data-action="edit" data-id="${u.id}">Edit</button></td>
          <td><button class="btn btn-sm btn-danger" data-action="delete" data-id="${u.id}">Delete</button></td>
        </tr>`;
        }).join('');
    }

    async function loadAll() {
        ROLES = await getJSON(api.roles);
        renderRolesSelect($createRoles, []);
        const roleUser = ROLES.find(r => r.name === 'ROLE_USER');
        if (roleUser) {
            [...$createRoles.options].forEach(o => { if (Number(o.value) === roleUser.id) o.selected = true; });
        }

        const users = await getJSON(api.users);
        renderUsersTable(users);
    }


    $createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData($createForm);
        const roleIds = [...$createRoles.selectedOptions].map(o => Number(o.value));
        const payload = {
            username: fd.get('username'),
            password: fd.get('password'),
            name: fd.get('name'),
            lastName: fd.get('lastName'),
            age: Number(fd.get('age')),
            email: fd.get('email'),
            roleIds
        };
        try {
            await sendJSON(api.users, 'POST', payload);
            $createForm.reset();
            renderRolesSelect($createRoles, roleIds);
            const users = await getJSON(api.users);
            renderUsersTable(users);
            const tabTriggerEl = document.querySelector('a[href="#users-pane"]');
            const tab = new bootstrap.Tab(tabTriggerEl);
            tab.show();
        } catch (err) {
            alert('Create failed: ' + err.message);
        }
    });

    $tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;

        if (action === 'delete') {
            if (!confirm(`Delete user #${id}?`)) return;
            try {
                await fetch(`${api.users}/${id}`, {method: 'DELETE', credentials: 'same-origin'});
                document.querySelector(`tr[data-id="${id}"]`)?.remove();
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        if (action === 'edit') {
            const u = await getJSON(`${api.users}/${id}`);
            openEditModal(u);
        }
    });

    function openEditModal(u) {

        const modalEl = document.createElement('div');
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit user #${u.id}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form class="m-0" id="edit-form">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Login</label>
                <input class="form-control" name="username" value="${u.username}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Password (leave blank to keep)</label>
                <input class="form-control" type="password" name="password" value="">
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">First Name</label>
                  <input class="form-control" name="name" value="${u.name}" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Last Name</label>
                  <input class="form-control" name="lastName" value="${u.lastName}" required>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Age</label>
                  <input class="form-control" type="number" min="0" name="age" value="${u.age}" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Email</label>
                  <input class="form-control" type="email" name="email" value="${u.email}" required>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Role</label>
                <select class="form-select" id="edit-roles" multiple size="2"></select>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </div>`;

        document.body.appendChild(modalEl);
        const modal = new bootstrap.Modal(modalEl);

        const $editRoles = modalEl.querySelector('#edit-roles');
        const selectedIds = u.roles.map(r => r.id);
        renderRolesSelect($editRoles, selectedIds);


        modalEl.querySelector('#edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const roleIds = [...$editRoles.selectedOptions].map(o => Number(o.value));
            const payload = {
                username: fd.get('username'),
                password: fd.get('password'),
                name: fd.get('name'),
                lastName: fd.get('lastName'),
                age: Number(fd.get('age')),
                email: fd.get('email'),
                roleIds
            };
            try {
                await sendJSON(`${api.users}/${u.id}`, 'PUT', payload);
                const users = await getJSON(api.users);
                renderUsersTable(users);
                modal.hide();
                setTimeout(() => modalEl.remove(), 250);
            } catch (err) {
                alert('Update failed: ' + err.message);
            }
        });

        modalEl.addEventListener('hidden.bs.modal', () => modalEl.remove());
        modal.show();
    }


    loadAll().catch(err => alert('Init failed: ' + err.message));
</script>
</body>
</html>
